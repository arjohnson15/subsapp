<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
    <h2 style="color: #4fc3f7;">Create or Edit User</h2>
    <button class="btn btn-secondary" onclick="showPage('users')">Back to Users</button>
</div>

<div class="form-container">
    <form id="userFormData" onsubmit="saveUser(event)">
        <div class="form-grid">
            <div class="form-group">
                <label for="userName">Name:</label>
                <input type="text" id="userName" name="name" required>
            </div>
            <div class="form-group">
                <label for="userEmail">Email:</label>
                <input type="email" id="userEmail" name="email" required>
            </div>
            <div class="form-group">
                <label for="userOwner">Owner:</label>
                <select id="userOwner" name="owner_id">
                    <option value="">-- No Owner --</option>
                </select>
            </div>
            <div class="form-group">
                <label for="plexEmail">Plex Email:</label>
                <input type="email" id="plexEmail" name="plex_email">
                <small style="color: #4fc3f7;">Email used for Plex invitations</small>
            </div>
        </div>

        <div class="form-group">
            <label>Tags:</label>
            <div class="checkbox-group">
                <div class="checkbox-item">
                    <input type="checkbox" id="tag-plex1" name="tags" value="Plex 1" onchange="updatePlexAccessCheckVisibility()">
                    <label for="tag-plex1">Plex 1</label>
                </div>
                <div class="checkbox-item">
                    <input type="checkbox" id="tag-plex2" name="tags" value="Plex 2" onchange="updatePlexAccessCheckVisibility()">
                    <label for="tag-plex2">Plex 2</label>
                </div>
                <div class="checkbox-item">
                    <input type="checkbox" id="tag-iptv" name="tags" value="IPTV" onchange="toggleIptvManagementByTag(this.checked)">
                    <label for="tag-iptv">IPTV</label>
                </div>
            </div>
        </div>

        <!-- CHECK FOR PLEX ACCESS SECTION -->
        <div class="form-group" id="plexAccessCheckSection" style="display: none;">
            <div class="plex-access-check-container">
                <div class="plex-access-check-header">
                    <h4>Check Existing Plex Access</h4>
                    <button type="button" class="check-access-btn" onclick="checkExistingPlexAccess()">
                        <span id="checkAccessBtnText"><i class="fas fa-search" style="color: #4fc3f7;"></i> Check for Plex Access</span>
                    </button>
                </div>
                <p class="check-access-description">
                    Use this if you've already invited this user to Plex and want to detect their current library access.
                </p>
                <div id="plexAccessResults" style="display: none;"></div>
            </div>
        </div>

        <!-- Plex Library Management -->
        <div class="form-group">
            <label>Plex Library Access:</label>
            <p style="color: #4fc3f7; font-size: 0.9rem; margin-bottom: 15px;">Select Plex 1 or Plex 2 tags above to configure library access</p>
            
            <!-- Plex 1 Libraries -->
            <div class="library-group" id="plex1LibraryGroup" style="display: none;">
                <div style="display: flex; align-items: center; justify-content: space-between;">
                    <h5>Plex 1 Libraries</h5>
                    <div class="plex-actions">
                        <button type="button" class="btn btn-test" style="padding: 6px 12px; font-size: 0.8rem;" onclick="testPlexConnection('plex1')">Test</button>
                        <button type="button" class="btn btn-sync" style="padding: 6px 12px; font-size: 0.8rem;" onclick="refreshPlexLibraries('plex1')">Refresh</button>
                        <button type="button" class="btn" style="background: linear-gradient(45deg, #9c27b0, #e91e63); padding: 6px 12px; font-size: 0.8rem;" onclick="debugPlexLibraries('plex1')">Debug</button>
                    </div>
                </div>
                <div style="margin-bottom: 15px;">
                    <span id="plex1Status" class="connection-status">Click Test Connection</span>
                    <button type="button" class="btn" style="margin-left: 10px; padding: 4px 12px; font-size: 0.8rem;" onclick="selectAllPlex1Libraries()">Select All</button>
                    <button type="button" class="btn btn-secondary" style="margin-left: 5px; padding: 4px 12px; font-size: 0.8rem;" onclick="clearAllPlex1Libraries()">Clear All</button>
                    <button type="button" class="btn" style="background: linear-gradient(45deg, #f44336, #e91e63); margin-left: 5px; padding: 4px 12px; font-size: 0.8rem;" onclick="Users.removePlexServerAccess('plex1')">Remove from Plex</button>
                </div>
                <div class="library-checkboxes">
                    <div class="library-group">
                        <h5>Regular Libraries</h5>
                        <div id="plex1RegularLibrariesList">Loading...</div>
                    </div>
                    <div class="library-group">
                        <h5>4K Libraries</h5>
                        <div id="plex1FourkLibrariesList">Loading...</div>
                    </div>
                </div>
            </div>

            <!-- Plex 2 Libraries -->
            <div class="library-group" id="plex2LibraryGroup" style="display: none;">
                <div style="display: flex; align-items: center; justify-content: space-between;">
                    <h5>Plex 2 Libraries</h5>
                    <div class="plex-actions">
                        <button type="button" class="btn btn-test" style="padding: 6px 12px; font-size: 0.8rem;" onclick="testPlexConnection('plex2')">Test</button>
                        <button type="button" class="btn btn-sync" style="padding: 6px 12px; font-size: 0.8rem;" onclick="refreshPlexLibraries('plex2')">Refresh</button>
                        <button type="button" class="btn" style="background: linear-gradient(45deg, #9c27b0, #e91e63); padding: 6px 12px; font-size: 0.8rem;" onclick="debugPlexLibraries('plex2')">Debug</button>
                    </div>
                </div>
                <div style="margin-bottom: 15px;">
                    <span id="plex2Status" class="connection-status">Click Test Connection</span>
                    <button type="button" class="btn" style="margin-left: 10px; padding: 4px 12px; font-size: 0.8rem;" onclick="selectAllPlex2Libraries()">Select All</button>
                    <button type="button" class="btn btn-secondary" style="margin-left: 5px; padding: 4px 12px; font-size: 0.8rem;" onclick="clearAllPlex2Libraries()">Clear All</button>
                    <button type="button" class="btn" style="background: linear-gradient(45deg, #f44336, #e91e63); margin-left: 5px; padding: 4px 12px; font-size: 0.8rem;" onclick="Users.removePlexServerAccess('plex2')">Remove from Plex</button>
                </div>
                <div class="library-checkboxes">
                    <div class="library-group">
                        <h5>Regular Libraries</h5>
                        <div id="plex2RegularLibrariesList">Loading...</div>
                    </div>
                    <div class="library-group">
                        <h5>4K Libraries</h5>
                        <div id="plex2FourkLibrariesList">Loading...</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- IPTV Subscription Management Section -->
        <div class="subscription-section" id="iptvSection" style="display: none;">
            <div class="subscription-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h5>IPTV Subscription Management</h5>
                <div class="iptv-actions">
                    <button type="button" class="btn btn-sync" style="padding: 6px 12px; font-size: 0.8rem;" onclick="IPTV.syncUserStatus()">Sync Status</button>
                    <button type="button" class="btn" style="background: linear-gradient(45deg, #4fc3f7, #29b6f6); padding: 6px 12px; font-size: 0.8rem;" onclick="IPTV.loadPackages()">Refresh Packages</button>
                    <button type="button" class="btn" style="background: linear-gradient(45deg, #9c27b0, #e91e63); padding: 6px 12px; font-size: 0.8rem;" onclick="IPTV.syncCredits()">Sync Credits</button>
                </div>
            </div>

            <!-- Current IPTV Status -->
            <div class="form-section" id="iptvCurrentStatus">
                <h6 style="color: #4fc3f7; margin-bottom: 15px;">Current IPTV Status</h6>
                <div id="iptvStatusDisplay" style="background: rgba(0, 0, 0, 0.3); padding: 15px; border-radius: 8px; border: 1px solid #333;">
                    <div class="status-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                        <div class="status-item">
                            <label style="color: #4fc3f7; font-size: 0.9rem;">Line ID:</label>
                            <span id="currentLineId" style="color: #fff; font-weight: 500;">None</span>
                        </div>
                        <div class="status-item">
                            <label style="color: #4fc3f7; font-size: 0.9rem;">Username:</label>
                            <span id="currentIptvUsername" style="color: #fff; font-weight: 500;">None</span>
                        </div>
                        <div class="status-item">
                            <label style="color: #4fc3f7; font-size: 0.9rem;">Package:</label>
                            <span id="currentPackage" style="color: #fff; font-weight: 500;">None</span>
                        </div>
                        <div class="status-item">
                            <label style="color: #4fc3f7; font-size: 0.9rem;">Expiration:</label>
                            <span id="currentExpiration" style="color: #fff; font-weight: 500;">None</span>
                        </div>
                        <div class="status-item">
                            <label style="color: #4fc3f7; font-size: 0.9rem;">Connections:</label>
                            <span id="currentConnections" style="color: #fff; font-weight: 500;">0/0</span>
                        </div>
                        <div class="status-item">
                            <label style="color: #4fc3f7; font-size: 0.9rem;">Credits Used:</label>
                            <span id="currentCreditsUsed" style="color: #fff; font-weight: 500;">0</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Action Selection -->
            <div class="form-section">
                <h6 style="color: #4fc3f7; margin-bottom: 15px;">Action</h6>
                <div style="display: flex; gap: 20px; margin-bottom: 20px;">
                    <label style="display: flex; align-items: center; cursor: pointer;">
                        <input type="radio" name="iptvAction" value="extend" id="iptvActionExtend" style="margin-right: 8px;" onchange="IPTV.handleActionChange()">
                        <span style="color: #fff;">Extend Current Subscription</span>
                    </label>
                    <label style="display: flex; align-items: center; cursor: pointer;">
                        <input type="radio" name="iptvAction" value="create" id="iptvActionCreate" style="margin-right: 8px;" onchange="IPTV.handleActionChange()" checked>
                        <span style="color: #fff;">Create New Subscription</span>
                    </label>
                </div>
            </div>

            <!-- Credit Balance Display -->
            <div class="form-section">
                <div style="display: flex; justify-content: space-between; align-items: center; background: rgba(76, 175, 80, 0.1); padding: 12px; border-radius: 8px; border: 1px solid #4caf50;">
                    <div>
                        <span style="color: #4caf50; font-weight: 500;">Available Credits: </span>
                        <span id="currentCreditBalance" style="color: #fff; font-size: 1.2rem; font-weight: bold;">Loading...</span>
                    </div>
                    <button type="button" class="btn" style="background: linear-gradient(45deg, #4caf50, #8bc34a); padding: 6px 12px; font-size: 0.8rem;" onclick="SettingsIPTV.syncCreditsBalance()">Sync Credits</button>
                </div>
            </div>

            <!-- Package Selection -->
            <div class="form-section">
                <h6 style="color: #4fc3f7; margin-bottom: 15px;">Package Selection</h6>
                <select id="iptvPackageSelect" style="width: 100%; padding: 10px; background: rgba(0, 0, 0, 0.7); color: #fff; border: 1px solid #4fc3f7; border-radius: 4px; margin-bottom: 15px;" onchange="IPTV.onPackageChange(this.value)">
                    <option value="">Loading packages...</option>
                </select>
                
                <!-- Package Summary -->
                <div id="iptvPackageSummary" style="background: rgba(0, 0, 0, 0.5); padding: 15px; border-radius: 8px; border: 1px solid #4fc3f7; margin-bottom: 15px; display: none;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <span style="color: #4fc3f7;">Selected: </span>
                            <span id="selectedPackageName" style="color: #fff; font-weight: bold;"></span>
                        </div>
                        <div>
                            <span style="color: #4caf50;">Credits Required: </span>
                            <span id="selectedPackageCredits" style="color: #fff; font-weight: bold;"></span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Channel Group Selection -->
            <div class="form-section">
                <h6 style="color: #4fc3f7; margin-bottom: 15px;">Channel Groups</h6>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <label for="channelGroupSelect" style="color: #fff;">Select Channel Group:</label>
                    <a href="#" onclick="showPage('settings')" style="color: #4fc3f7; font-size: 0.9rem; text-decoration: none;">Manage Channel Groups</a>
                </div>
                <select id="channelGroupSelect" style="width: 100%; padding: 10px; background: rgba(0, 0, 0, 0.7); color: #fff; border: 1px solid #4fc3f7; border-radius: 4px;">
                    <option value="">Loading channel groups...</option>
                </select>
                <small style="color: #4fc3f7; font-size: 0.85rem;">Channel groups define which bouquets (channel packages) the user will receive.</small>
            </div>

            <!-- Subscription Details -->
            <div class="form-section">
                <h6 style="color: #4fc3f7; margin-bottom: 15px;">Subscription Details</h6>
                <div class="form-grid" style="grid-template-columns: 1fr 1fr;">
                    <div class="form-group">
                        <label for="iptvUsernameField" style="color: #fff;">Username:</label>
                        <div style="display: flex; gap: 8px;">
                            <input type="text" id="iptvUsernameField" placeholder="Enter username" style="flex: 1; padding: 8px; background: rgba(0, 0, 0, 0.7); color: #fff; border: 1px solid #4fc3f7; border-radius: 4px;">
                            <button type="button" class="btn" style="padding: 8px 12px; font-size: 0.8rem;" onclick="IPTV.generateUsername()">Generate</button>
                        </div>
                        <small style="color: #4fc3f7; font-size: 0.85rem;">Required for new subscriptions.</small>
                    </div>
                    <div class="form-group">
                        <label for="iptvPasswordField" style="color: #fff;">Password:</label>
                        <div style="display: flex; gap: 8px;">
                            <input type="text" id="iptvPasswordField" placeholder="Enter password" style="flex: 1; padding: 8px; background: rgba(0, 0, 0, 0.7); color: #fff; border: 1px solid #4fc3f7; border-radius: 4px;">
                            <button type="button" class="btn" style="padding: 8px 12px; font-size: 0.8rem;" onclick="IPTV.generatePassword()">Generate</button>
                        </div>
                        <small style="color: #4fc3f7; font-size: 0.85rem;">Required for new subscriptions.</small>
                    </div>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="form-section">
                <div style="display: flex; gap: 15px; justify-content: center;">
                    <button type="button" id="createTrialBtn" class="btn" style="background: linear-gradient(45deg, #ff9800, #ff5722); padding: 10px 20px;" onclick="IPTV.createTrialSubscription()">Create Trial Subscription</button>
                    <button type="button" id="createPaidBtn" class="btn" style="background: linear-gradient(45deg, #4caf50, #8bc34a); padding: 10px 20px;" onclick="IPTV.createPaidSubscription()">Create Paid Subscription</button>
                    <button type="button" id="extendBtn" class="btn" style="background: linear-gradient(45deg, #2196f3, #03a9f4); padding: 10px 20px; display: none;" onclick="IPTV.extendSubscription()">Extend Subscription</button>
                </div>
                
                <!-- Status Feedback -->
                <div id="iptvStatusFeedback" style="margin-top: 15px; text-align: center; display: none;">
                    <div id="iptvStatusMessage" style="padding: 10px; border-radius: 8px; font-weight: 500;"></div>
                </div>
            </div>

            <!-- Activity Log -->
            <div class="form-section">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h6 style="color: #4fc3f7; margin: 0;">Recent IPTV Activity</h6>
                    <button type="button" class="btn" style="padding: 6px 12px; font-size: 0.8rem;" onclick="IPTV.loadActivityLog()">Refresh</button>
                </div>
                <div id="iptvActivityLog" style="max-height: 200px; overflow-y: auto; background: rgba(0, 0, 0, 0.3); border: 1px solid #333; border-radius: 8px;">
                    <div style="padding: 20px; text-align: center; color: #666;">
                        Click Refresh to load activity history...
                    </div>
                </div>
            </div>
        </div>

        <div class="form-group">
            <label>Subscription Information:</label>
            <div class="form-grid">
                <div class="form-group">
                    <label for="plexSubscription">Plex Subscription:</label>
                    <select id="plexSubscription" name="plex_subscription" onchange="calculateNewPlexExpiration()">
                        <option value="">No Plex Subscription</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="plexExpiration">Plex Expiration:</label>
                    <input type="date" id="plexExpiration" name="plex_expiration">
                    <small style="color: #4fc3f7;">Manual override - leave blank for auto-calculation</small>
                </div>
                <div class="form-group">
                    <label for="iptvSubscription">IPTV Subscription:</label>
                    <select id="iptvSubscription" name="iptv_subscription" onchange="calculateNewIptvExpiration()">
                        <option value="">No IPTV Subscription</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="iptvExpiration">IPTV Expiration:</label>
                    <input type="date" id="iptvExpiration" name="iptv_expiration">
                    <small style="color: #4fc3f7;">Manual override - leave blank for auto-calculation</small>
                </div>
            </div>
        </div>

        <div class="form-group">
            <label>Optional Details:</label>
            <div class="form-grid">
                <div class="form-group">
                    <label for="iptvUsername">IPTV Username:</label>
                    <input type="text" id="iptvUsername" name="iptv_username">
                </div>
                <div class="form-group">
                    <label for="iptvPassword">IPTV Password:</label>
                    <input type="text" id="iptvPassword" name="iptv_password">
                </div>
                <div class="form-group">
                    <label for="implayerCode">iMPlayer Code:</label>
                    <input type="text" id="implayerCode" name="implayer_code">
                </div>
                <div class="form-group">
                    <label for="deviceCount">iMPlayer Device Count:</label>
                    <input type="number" id="deviceCount" name="device_count" min="1" value="1">
                </div>
            </div>
        </div>

        <div class="form-group">
            <label>Email & Owner Settings:</label>
            <div class="checkbox-group">
                <div class="checkbox-item">
                    <input type="checkbox" id="bccOwnerRenewal" name="bcc_owner_renewal">
                    <label for="bccOwnerRenewal">BCC Owner on Renewal Reminders</label>
                </div>
                <div class="checkbox-item">
                    <input type="checkbox" id="excludeBulkEmails" name="exclude_bulk_emails">
                    <label for="excludeBulkEmails">Exclude from Bulk Emails</label>
                </div>
                <div class="checkbox-item">
                    <input type="checkbox" id="excludeAutomatedEmails" name="exclude_automated_emails">
                    <label for="excludeAutomatedEmails">Exclude from Automated Emails</label>
                </div>
            </div>
        </div>

        <div style="text-align: center; margin-top: 30px;">
            <button type="submit" class="btn">Save User</button>
            <button type="button" class="btn btn-secondary" onclick="showPage('users')">Cancel</button>
        </div>
    </form>
</div>